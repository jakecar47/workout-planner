<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Exercises</title>
    <link rel="stylesheet" href="/css/style.css">
</head>

<body>

{{> fragments/nav_bar}}

<!-- MAIN CONTENT -->
<div class="page-container">

    <h1 class="section-title">Exercise Library</h1>

    <!-- SEARCH BAR -->
    <div class="exercise-search">
        <input
            type="text"
            id="exerciseSearch"
            placeholder="Search exercises..."
            onkeyup="showDropdown()"
            onkeydown="checkEnter(event)"
            autocomplete="off"
        >
        <div id="autocomplete-list" class="autocomplete-box"></div>
    </div>

    <!-- EMPTY STATE -->
    <p id="startPrompt" class="no-data">
        Start typing to search for an exercise
    </p>

    <!-- SINGLE RESULT GRID (INITIALLY EMPTY) -->
    <div class="exercise-grid" id="exerciseGrid" style="display:none;">
        <!-- Cards injected dynamically by JS -->
    </div>

    <!-- ADD EXERCISE BUTTON -->
    <div class="center-button mt-40">
        <button class="black-button" onclick="openWizard()">
            Add Exercise
        </button>
    </div>
</div>

<!-- ADD EXERCISE WIZARD -->
<div id="exerciseWizard" class="wizard-overlay" style="display:none;">
    <div class="wizard-modal">

        <h2 class="section-title">Add New Exercise</h2>

        <form
            id="exerciseForm"
            method="POST"
            action="/exercises/create"
            enctype="multipart/form-data"
        >

            <!-- STEP 1 -->
            <div class="wizard-step" id="step1">
                <label>Exercise Name</label>
                <input type="text" name="name" required>

                <label>Target Muscle</label>
                <input type="text" name="targetMuscle">

                <div class="wizard-buttons">
                    <button type="button" class="black-button" onclick="nextStep()">Next</button>
                </div>
            </div>

            <!-- STEP 2 -->
            <div class="wizard-step" id="step2" style="display:none;">
                <label>Description</label>
                <textarea name="description" rows="4"></textarea>

                <label>Upload Image</label>
                <input type="file" name="image" accept="image/*" onchange="onImageSelected(event)">

                <p id="imageStatus" class="image-status" style="display:none; margin-top:10px;">
                       Image loaded successfully!
                </p>

                <div class="wizard-buttons">
                    <button type="button" class="black-button" onclick="prevStep()">Back</button>
                    <button type="submit" class="black-button">Done</button>
                    <button type="button" class="black-button" onclick="closeWizard()">Cancel</button>
                </div>
            </div>

        </form>

    </div>
</div>

<!-- AUTOCOMPLETE AND CARD RENDERING LOGIC -->
<script>
let currentMatches = [];
let activeIndex = -1;

document.addEventListener("DOMContentLoaded", () => {
    const input = document.getElementById("exerciseSearch");
    const list = document.getElementById("autocomplete-list");
    input.addEventListener("focus", () => {
        if (currentMatches.length === 0) {
            loadAllExercises();
        } else {
            list.style.display = "block";
        }
    });
});

/* Auto-show dropdown when clicking input */
document.addEventListener("DOMContentLoaded", () => {
    const searchInput = document.getElementById("exerciseSearch");
    const list = document.getElementById("autocomplete-list");

    if (!searchInput || !list) return;

    // Show dropdown on click if results exist
    searchInput.addEventListener("focus", () => {
        if (currentMatches.length > 0) {
            list.style.display = "block";
        }
    });

    // Hide dropdown when clicking outside
    document.addEventListener("click", (e) => {
        if (e.target !== searchInput && !list.contains(e.target)) {
            list.style.display = "none";
        }
    });
});


/**
 * Render a single exercise card in the grid
 */
function renderExerciseCard(exercise) {
    const grid = document.getElementById("exerciseGrid");
    const prompt = document.getElementById("startPrompt");

    // Clear existing content
    grid.innerHTML = "";

    const card = document.createElement("div");
    card.className = "exercise-card";

    const imgSrc = exercise.imagePath ? exercise.imagePath : "/images/default-exercise.png";

    card.innerHTML = `
        <img src="${imgSrc}" class="exercise-image" alt="Exercise image">

        <h3 class="exercise-name">${exercise.name}</h3>

        <div class="exercise-meta">
            <span><strong>Target Muscle:</strong> ${exercise.targetMuscle || "N/A"}</span>
        </div>

        <p class="exercise-desc">
            <strong>Description:</strong> ${exercise.description || "No description provided."}
        </p>
    `;

    grid.appendChild(card);

    grid.style.display = "flex";
    prompt.style.display = "none";
}

function loadAllExercises() {
    const list = document.getElementById("autocomplete-list");
    fetch(`/api/exercises/search?query=`)
        .then(resp => resp.json())
        .then(data => {
            currentMatches = data || [];
            list.innerHTML = "";

            currentMatches.forEach((ex, index) => {
                const div = document.createElement("div");
                div.className = "autocomplete-item";
                div.innerText = ex.name;

                div.onclick = () => {
                    document.getElementById("exerciseSearch").value = ex.name;
                    list.style.display = "none";
                    renderExerciseCard(ex);
                };

                list.appendChild(div);
            });

            if (currentMatches.length > 0) {
                list.style.display = "block";
            }
        });
}

/**
 * Called on each keyup in the search input
 */
function showDropdown() {
    const inputEl = document.getElementById("exerciseSearch");
    const input = inputEl.value.trim();
    const list = document.getElementById("autocomplete-list");
    const grid = document.getElementById("exerciseGrid");
    const prompt = document.getElementById("startPrompt");

    list.innerHTML = "";
    activeIndex = -1;
    grid.style.display = "none";
    prompt.style.display = "block";

    if (!input) {
        currentMatches = [];
        return;
    }

    fetch(`/api/exercises/search?query=${encodeURIComponent(input)}`)
        .then(resp => resp.json())
        .then(data => {
            currentMatches = data || [];
            list.innerHTML = "";

            currentMatches.forEach((exercise, index) => {
                const div = document.createElement("div");
                div.className = "autocomplete-item";
                div.innerText = exercise.name;

                div.onclick = () => {
                    document.getElementById("exerciseSearch").value = exercise.name;
                    list.innerHTML = "";
                    list.style.display = "none";
                    renderExerciseCard(exercise);
                };

                list.appendChild(div);
            });
            
            if(currentMatches.length > 0) {
                list.style.display = "block";
            }
        })
        

        .catch(err => {
            console.error("Error fetching exercises:", err);
        });
}

/**
 * Keyboard navigation + selection
 */
function checkEnter(e) {
    const list = document.getElementsByClassName("autocomplete-item");

    if (e.key === "ArrowDown") {
        if (list.length === 0) return;
        activeIndex++;
        highlight(list);
        return;
    }

    if (e.key === "ArrowUp") {
        if (list.length === 0) return;
        activeIndex--;
        highlight(list);
        return;
    }

    if (e.key === "Enter") {
        e.preventDefault();
        const inputVal = document.getElementById("exerciseSearch").value.trim();

        if (activeIndex >= 0 && list[activeIndex]) {
            // Use highlighted item
            const name = list[activeIndex].innerText;
            const match = currentMatches.find(ex => ex.name === name);
            if (match) {
                document.getElementById("autocomplete-list").innerHTML = "";
                renderExerciseCard(match);
            }
            return;
        }

        // If no highlight, try exact text match
        const exact = currentMatches.find(ex =>
            ex.name.toLowerCase() === inputVal.toLowerCase()
        );
        if (exact) {
            document.getElementById("autocomplete-list").innerHTML = "";
            renderExerciseCard(exact);
        }
    }
}

/**
 * Highlight current item in dropdown
 */
function highlight(list) {
    for (let i = 0; i < list.length; i++) {
        list[i].classList.remove("active");
    }

    if (list.length === 0) {
        activeIndex = -1;
        return;
    }

    if (activeIndex >= list.length) activeIndex = 0;
    if (activeIndex < 0) activeIndex = list.length - 1;

    list[activeIndex].classList.add("active");
}
</script>

<script>
function openWizard() {
    document.getElementById("exerciseWizard").style.display = "flex";
}

function closeWizard() {
    document.getElementById("exerciseWizard").style.display = "none";
    // Optional: reset wizard to step 1
    document.getElementById("step1").style.display = "block";
    document.getElementById("step2").style.display = "none";
    document.getElementById("exerciseForm").reset();
    const status = document.getElementById("imageStatus");
    if (status) status.style.display = "none";
}

function nextStep() {
    document.getElementById("step1").style.display = "none";
    document.getElementById("step2").style.display = "block";
}

function prevStep() {
    document.getElementById("step2").style.display = "none";
    document.getElementById("step1").style.display = "block";
}

/**
 * Just show a success message when an image is picked
 */
function onImageSelected(event) {
    const status = document.getElementById("imageStatus");
    if (event.target.files && event.target.files.length > 0) {
        status.style.display = "block";
    } else {
        status.style.display = "none";
    }
}
</script>

</body>
</html>
