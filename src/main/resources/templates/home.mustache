<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Home</title>
  <link rel="stylesheet" href="/css/style.css">
</head>
<body>
{{> fragments/nav_bar}}

<div class="page-container home-grid">
  <table class="weekly-table" aria-label="Weekly workout plan">
    <thead>
      <tr><th>DAY</th><th>WORKOUT</th><th>NOTES</th><th>ACTIONS</th></tr>
    </thead>
    <tbody>
      {{#dayRows}}
      <tr data-day="{{key}}">
        <td class="day-cell">{{key}}</td>
        <td>
          <div class="assign-row">
            <div id="assigned-{{key}}" class="assigned-display">
              {{#workoutName}}
                <a href="/workouts/{{workoutId}}" class="workout-link">{{workoutName}}</a>
              {{/workoutName}}
              {{^workoutName}}-- No workout assigned --{{/workoutName}}
            </div>
          </div>
        </td>
        <td>
          <textarea id="notes-{{key}}" class="notes-input" rows="2" placeholder="No notes yet">{{#notes}}{{notes}}{{/notes}}</textarea>

          <div class="save-row">
            <button type="button" id="save-{{key}}" onclick="saveNotes('{{key}}')" class="black-button primary" aria-label="Save notes for {{key}}">
              Save
            </button>
          </div>
        </td>
        <td class="actions-cell">
          <a
            href="/workouts/assign?day={{key}}"
            class="black-button primary"
            aria-label="Assign workout for {{key}}"
          >Assign Workout</a>

          <button
            type="button"
            id="clear-{{key}}"
            onclick="clearDay('{{key}}')"
            class="black-button danger"
            aria-label="Clear workout and notes for {{key}}"
          >Clear</button>
        </td>
      </tr>
      {{/dayRows}}
    </tbody>
  </table>
</div>

<script>
  // Save notes for a day (called by Save button)
  function saveNotes(day) {
    const notesEl = document.getElementById(`notes-${day}`);
    const saveBtn = document.getElementById(`save-${day}`);
    if (saveBtn) saveBtn.disabled = true;

    const notes = notesEl ? notesEl.value : '';

    fetch('/weekly-plan/notes', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ day, notes })
    })
    .then(response => {
      if (!response.ok) throw new Error('Server error');
      return response.json().catch(() => ({}));
    })
    .then(() => {
      if (saveBtn) {
        saveBtn.textContent = 'Saved';
        setTimeout(() => { saveBtn.textContent = 'Save'; }, 900);
      }
    })
    .catch(err => {
      alert('Failed to save notes: ' + err.message);
    })
    .finally(() => {
      if (saveBtn) saveBtn.disabled = false;
    });
  }

  // Clear notes in the DOM and request the server to clear the workout & notes for the day.
  // Endpoint: POST /weekly-plan/clear  with JSON body { day: "<day>" }
  function clearDay(day) {
    const notesEl = document.getElementById(`notes-${day}`);
    const assignedEl = document.getElementById(`assigned-${day}`);
    const clearBtn = document.getElementById(`clear-${day}`);

    if (clearBtn) clearBtn.disabled = true;

    // Update UI immediately
    if (notesEl) notesEl.value = '';
    if (assignedEl) assignedEl.innerHTML = '-- No workout assigned --';

    // Send request to server to persist the clear action.
    fetch('/weekly-plan/clear', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ day })
    })
    .then(response => {
      if (!response.ok) throw new Error('Server error');
      return response.json().catch(() => ({}));
    })
    .catch(err => {
      alert('Failed to clear day: ' + err.message);
    })
    .finally(() => {
      if (clearBtn) clearBtn.disabled = false;
    });
  }

  // Load weekly plan JSON and update DOM so newly assigned workouts (from assign_workout) show immediately
  async function loadWeeklyPlanAndUpdate() {
    try {
      const res = await fetch('/weekly-plan', { credentials: 'same-origin' });
      if (!res.ok) return;
      const plan = await res.json(); // format: { "MON": { workoutId: 5, workoutName?: "Legs", notes: "..." }, ... }

      // collect ids missing a name
      const missingIds = new Set();
      for (const [, entry] of Object.entries(plan || {})) {
        if (entry && entry.workoutId && !entry.workoutName) missingIds.add(Number(entry.workoutId));
      }

      // helper map id -> name (if needed fetch all via API)
      const idToName = {};
      if (missingIds.size > 0) {
        try {
          const resp = await fetch('/workouts/api/search', { credentials: 'same-origin' }); // include credentials
          if (resp.ok) {
            const all = await resp.json();
            (all || []).forEach(w => {
              if (w && (w.id != null)) {
                idToName[String(w.id)] = w.name || w.workoutName || '';
              }
            });
          }
        } catch (e) {
          // swallow - we'll fallback to "Workout <id>"
        }
      }

      for (const [day, entry] of Object.entries(plan || {})) {
        try {
          const assignedEl = document.getElementById(`assigned-${day}`);
          const notesEl = document.getElementById(`notes-${day}`);
          if (assignedEl) {
            if (entry && entry.workoutId) {
              // prefer explicit workoutName from plan, then lookup, then friendly fallback
              const key = String(entry.workoutId);
              const name = entry.workoutName || idToName[key] || (`Workout ${entry.workoutId}`);
              assignedEl.innerHTML = `<a href="/workouts/${entry.workoutId}" class="workout-link">${escapeHtml(name)}</a>`;
            } else {
              assignedEl.innerHTML = '-- No workout assigned --';
            }
          }
          if (notesEl) {
            notesEl.value = (entry && entry.notes) ? entry.notes : '';
          }
        } catch (e) {
          // ignore per-day update errors
        }
      }
    } catch (e) {
      console.debug('Unable to refresh weekly plan:', e);
    }
  }

  // simple HTML escape for injected names
  function escapeHtml(s) {
    return String(s)
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#39;');
  }

  // refresh plan on load so assignments made in assign_workout show up after redirect
  document.addEventListener('DOMContentLoaded', function() {
    loadWeeklyPlanAndUpdate();
  });
</script>

</body>
</html>